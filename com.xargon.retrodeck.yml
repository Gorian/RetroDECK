app-id: com.xargon.retrodeck
runtime: org.kde.Platform
runtime-version: '5.15-21.08'
sdk: org.kde.Sdk
command: emulationstation
#command: retroarch #--appendconfig /app/retrodeck/retroarch/.config/retroarch.cfg

finish-args:
   - --socket=x11
   - --socket=wayland
   - --socket=pulseaudio
   - --share=ipc
   - --share=network
   - --device=all
   - --filesystem=~/retrodeck/roms:create
   - --allow=multiarch
   - --talk-name=org.freedesktop.ScreenSaver
   - --talk-name=org.freedesktop.PowerManagement.Inhibit
   - --talk-name=org.freedesktop.login1
   - --filesystem=host
   - --filesystem=xdg-run/app/com.discordapp.Discord:create

modules:

  # ES-DE dependency 
  - name: pugixml
    buildsystem: cmake
    config-opts:
    - -DBUILD_SHARED_LIBS=on .
    sources:
    - type: archive
      url: https://github.com/zeux/pugixml/releases/download/v1.11.4/pugixml-1.11.4.tar.gz
      sha256: 8ddf57b65fb860416979a3f0640c2ad45ddddbbafa82508ef0a0af3ce7061716

  # ES-DE dependency 
  - name: freeimage
    no-autogen: true
    build-options:
      #C++17 is not supported
      cxxflags: -std=c++14
    make-args:
    - DESTDIR=/app
    sources:
    - type: archive
      url: http://downloads.sourceforge.net/freeimage/FreeImage3180.zip
      sha256: f41379682f9ada94ea7b34fe86bf9ee00935a3147be41b6569c9605a53e438fd
    - type: shell
      commands:
      - sed -i 's|-o root -g root ||' ./Makefile.gnu
      - sed -i 's|/usr|/app|' ./Makefile.gnu

  # ES-DE dependency 
  - name: ffmpeg
    config-opts:
      - --enable-shared
      - --disable-static
      - --enable-gnutls
      - --disable-doc
      - --disable-programs
      - --disable-encoders
      - --disable-muxers
      - --enable-encoder=png
    sources:
      - type: archive
        url: https://www.ffmpeg.org/releases/ffmpeg-4.2.3.tar.xz
        sha256: 9df6c90aed1337634c1fb026fb01c154c29c82a64ea71291ff2da9aacb9aad31
    cleanup:
      - /share/ffmpeg/examples

  - name: emulationstation-de
    buildsystem: cmake
    config-opts:
      - -DCMAKE_INSTALL_PREFIX=/app
    cleanup:
      - es-app
      - es-core
    sources:
    - type: git
      url: https://gitlab.com/leonstyhre/emulationstation-de.git
      branch: stable-1.2

  # - yuzu
  # - name: ryujinx
  # - name: xemu
  # - name: rpcs3
  # - name: pcsx2
  # - name: vita3k
  # - name: dolphin
  # - name: arduboy

  - name: art-book-next
    buildsystem: simple
    build-commands:
      - mkdir -p /app/emulationstation/themes/art-book-next
      - mv -f * /app/emulationstation/themes/art-book-next/
    sources:
      - type: git
        url: https://github.com/anthonycaccese/es-theme-art-book-next.git
        branch: eaf73a4eefde22791681c7f430a238fb324bdeaf


  # External manifests start

  # RetroArch - https://github.com/flathub/org.libretro.RetroArch
  # nope: remember to put ' /org.libretro.RetroArch/' as submodules prefix

  - name: retroarch
    config-opts:
      - '--enable-dbus'
    make-args:
      - GLOBAL_CONFIG_DIR=${FLATPAK_DEST}/etc
    sources:
      - type: git
        url: https://github.com/libretro/RetroArch.git
        branch: 60fab1c4a169beb46b7b79d2ae549e12f05c53fc
      - type: file
        path: org.libretro.RetroArch.appdata.xml
      - type: file
        path: retroarch.cfg
    post-install:
      - mkdir -p ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/
      - >-
        mv ${FLATPAK_DEST}/share/pixmaps/retroarch.svg
        ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/
      - rmdir ${FLATPAK_DEST}/share/pixmaps/
      - mkdir -p ${FLATPAK_DEST}/etc
      - >-
        sed s:@prefix@:${FLATPAK_DEST}:g retroarch.cfg >
        ${FLATPAK_DEST}/etc/retroarch.cfg
      - mkdir -p ${FLATPAK_DEST}/share/appdata
      - cp org.libretro.RetroArch.appdata.xml ${FLATPAK_DEST}/share/appdata
    modules:
      - libpng/libpng-1.6.35.json
      - nvidia-cg-toolkit/nvidia-cg-toolkit-3.1.0013.json
      - shared-modules/SDL/SDL-1.2.15.json
      - shared-modules/SDL/SDL_image-1.2.12.json
      - shared-modules/SDL/SDL_mixer-1.2.12.json
      - shared-modules/SDL/SDL_net-1.2.8.json
      - shared-modules/SDL/SDL_ttf-2.0.11.json
      - shared-modules/libusb/libusb.json
      - shared-modules/gudev/gudev.json
      - libbz2/libbz2-1.0.8.json
      - xrandr/xrandr-1.5.1.json
      - libaio/libaio-0.3.112.json
      - shared-modules/glu/glu-9.json
      - libdecor/libdecor-0.1.0.json
  - name: retroarch-filers-video
    subdir: gfx/video_filters
    make-install-args:
      - PREFIX=${FLATPAK_DEST}
    sources:
      - type: git
        url: https://github.com/libretro/RetroArch.git
        commit: 60fab1c4a169beb46b7b79d2ae549e12f05c53fc
  - name: retroarch-filers-audio
    subdir: libretro-common/audio/dsp_filters
    make-install-args:
      - PREFIX=${FLATPAK_DEST}
    sources:
      - type: git
        url: https://github.com/libretro/RetroArch.git
        commit: 60fab1c4a169beb46b7b79d2ae549e12f05c53fc
  - name: retroarch-assets
    make-install-args:
      - PREFIX=${FLATPAK_DEST}
    sources:
      - type: git
        url: https://github.com/libretro/retroarch-assets.git
        commit: f45dd1351e6bfb9f01e12bee8d358ad22a2bb8f9
  - name: libretro-database
    make-install-args:
      - PREFIX=${FLATPAK_DEST}
    sources:
      - type: git
        url: https://github.com/libretro/libretro-database.git
        commit: 1754130f72d8c00a512797bf85442576258279e8
  - name: libretro-core-info
    make-install-args:
      - PREFIX=${FLATPAK_DEST}
    sources:
      - type: git
        url: https://github.com/libretro/libretro-core-info.git
        commit: 1b2472eca14a5a187ff298ace1b614fd3d47bc7c
  - name: retroarch-joypad-autoconfig
    make-install-args:
      - PREFIX=${FLATPAK_DEST}
    sources:
      - type: git
        url: https://github.com/libretro/retroarch-joypad-autoconfig.git
        commit: 0eb3ad2666e6bdc2de2cde4c5d4af29b8c7f2c67
  - name: common-shaders
    make-install-args:
      - PREFIX=${FLATPAK_DEST}
    sources:
      - type: git
        url: https://github.com/libretro/common-shaders.git
        commit: 55e401834b732e62c34411321c4ffd82524345d4
  - name: slang-shaders
    make-install-args:
      - PREFIX=${FLATPAK_DEST}
    sources:
      - type: git
        url: https://github.com/libretro/slang-shaders.git
        commit: 77558d5f2ac807b27201fb888cbf2caee8e289fa
  - name: glsl-shaders
    make-install-args:
      - PREFIX=${FLATPAK_DEST}
    sources:
      - type: git
        url: https://github.com/libretro/glsl-shaders.git
        commit: 20801b38aa2c89a2beb9f57ffbbbcea7256e2523
  - name: common-overlays
    make-install-args:
      - PREFIX=${FLATPAK_DEST}
    sources:
      - type: git
        url: https://github.com/libretro/common-overlays.git
        commit: db9744f4e58a740f0f10b04b62af347cd6f01928

  # RetroArch - END


  # External manifests end
  

  - name: retrodeck
    buildsystem: simple
    build-commands:
        - mkdir -p ~/retrodeck/roms/bios
        - mkdir -p ~/retrodeck/roms/3do
        - mkdir -p ~/retrodeck/roms/amiga
        - mkdir -p ~/retrodeck/roms/amigacd32
        - mkdir -p ~/retrodeck/roms/amstradcpc
        - mkdir -p ~/retrodeck/roms/arcade
        - mkdir -p ~/retrodeck/roms/atari2600
        - mkdir -p ~/retrodeck/roms/atari5200
        - mkdir -p ~/retrodeck/roms/atari7800
        - mkdir -p ~/retrodeck/roms/atarist
        - mkdir -p ~/retrodeck/roms/atari800
        - mkdir -p ~/retrodeck/roms/atomiswave
        - mkdir -p ~/retrodeck/roms/channelf
        - mkdir -p ~/retrodeck/roms/colecovision
        - mkdir -p ~/retrodeck/roms/c64
        - mkdir -p ~/retrodeck/roms/c128
        - mkdir -p ~/retrodeck/roms/vic20
        - mkdir -p ~/retrodeck/roms/laserdisc
        - mkdir -p ~/retrodeck/roms/dreamcast
        - mkdir -p ~/retrodeck/roms/easyrpg
        - mkdir -p ~/retrodeck/roms/famicom
        - mkdir -p ~/retrodeck/roms/fbn
        - mkdir -p ~/retrodeck/roms/gb
        - mkdir -p ~/retrodeck/roms/gbh
        - mkdir -p ~/retrodeck/roms/gameandwatch
        - mkdir -p ~/retrodeck/roms/gba
        - mkdir -p ~/retrodeck/roms/fds
        - mkdir -p ~/retrodeck/roms/c16
        - mkdir -p ~/retrodeck/roms/ggh
        - mkdir -p ~/retrodeck/roms/gbah
        - mkdir -p ~/retrodeck/roms/intellivision
        - mkdir -p ~/retrodeck/roms/gbch
        - mkdir -p ~/retrodeck/roms/atarilynx
        - mkdir -p ~/retrodeck/roms/mame
        - mkdir -p ~/retrodeck/roms/dos
        - mkdir -p ~/retrodeck/roms/snesmsu1
        - mkdir -p ~/retrodeck/roms/msx
        - mkdir -p ~/retrodeck/roms/msx2
        - mkdir -p ~/retrodeck/roms/naomi
        - mkdir -p ~/retrodeck/roms/neogeo
        - mkdir -p ~/retrodeck/roms/ngp
        - mkdir -p ~/retrodeck/roms/nds
        - mkdir -p ~/retrodeck/roms/n64
        - mkdir -p ~/retrodeck/roms/nes
        - mkdir -p ~/retrodeck/roms/nesh
        - mkdir -p ~/retrodeck/roms/ngpc
        - mkdir -p ~/retrodeck/roms/neocd
        - mkdir -p ~/retrodeck/roms/pc-9800
        - mkdir -p ~/retrodeck/roms/pcengine
        - mkdir -p ~/retrodeck/roms/pcenginecd
        - mkdir -p ~/retrodeck/roms/pcfx
        - mkdir -p ~/retrodeck/roms/openbor
        - mkdir -p ~/retrodeck/roms/piece
        - mkdir -p ~/retrodeck/roms/odyssey2
        - mkdir -p ~/retrodeck/roms/psp
        - mkdir -p ~/retrodeck/roms/pspminis
        - mkdir -p ~/retrodeck/roms/pokemini
        - mkdir -p ~/retrodeck/roms/homebrew
        - mkdir -p ~/retrodeck/roms/ports
        - mkdir -p ~/retrodeck/roms/sc-3000
        - mkdir -p ~/retrodeck/roms/scummvm
        - mkdir -p ~/retrodeck/roms/psx
        - mkdir -p ~/retrodeck/roms/segacd
        - mkdir -p ~/retrodeck/roms/sega32x
        - mkdir -p ~/retrodeck/roms/genesis
        - mkdir -p ~/retrodeck/roms/genh
        - mkdir -p ~/retrodeck/roms/mastersystem
        - mkdir -p ~/retrodeck/roms/megadrive
        - mkdir -p ~/retrodeck/roms/megaduck
        - mkdir -p ~/retrodeck/roms/saturn
        - mkdir -p ~/retrodeck/roms/sg-1000
        - mkdir -p ~/retrodeck/roms/x1
        - mkdir -p ~/retrodeck/roms/zxspectrum
        - mkdir -p ~/retrodeck/roms/zx81
        - mkdir -p ~/retrodeck/roms/pc-8800
        - mkdir -p ~/retrodeck/roms/snes
        - mkdir -p ~/retrodeck/roms/supergrafx
        - mkdir -p ~/retrodeck/roms/pico-8
        - mkdir -p ~/retrodeck/roms/megacd
        - mkdir -p ~/retrodeck/roms/snesh
        - mkdir -p ~/retrodeck/roms/satellaview
        - mkdir -p ~/retrodeck/roms/sfc
        - mkdir -p ~/retrodeck/roms/sufami
        - mkdir -p ~/retrodeck/roms/tic-80
        - mkdir -p ~/retrodeck/roms/tg16
        - mkdir -p ~/retrodeck/roms/solarus
        - mkdir -p ~/retrodeck/roms/vectrex
        - mkdir -p ~/retrodeck/roms/gbc
        - mkdir -p ~/retrodeck/roms/videopac
        - mkdir -p ~/retrodeck/roms/virtualboy
        - mkdir -p ~/retrodeck/roms/wonderswan
        - mkdir -p ~/retrodeck/roms/wonderswancolor
        - mkdir -p ~/retrodeck/roms/ecwolf
        - mkdir -p ~/retrodeck/roms/x68000
        - mkdir -p ~/retrodeck/roms/build
        - mkdir -p ~/retrodeck/roms/tools
        - mkdir -p ~/retrodeck/roms/imageviewer
        - mkdir -p ~/retrodeck/roms/gamegear
        - mkdir -p ~/retrodeck/roms/tg16cd
        - mkdir -p ~/retrodeck/roms/j2me
        - mkdir -p ~/retrodeck/roms/uzebox
        - mkdir -p ~/retrodeck/roms/supervision
        - mkdir -p ~/retrodeck/roms/doom
        - mkdir -p ~/retrodeck/roms/switch
        - mkdir -p ~/retrodeck/roms/wii
        - mkdir -p ~/retrodeck/roms/gc
        - mkdir -p ~/retrodeck/roms/3ds

        - rm -f /app/retrodeck/retroarch/.config/retroarch.cfg
        - mv retroarch.cfg /app/retrodeck/retroarch/.config/

    #cleanup: ['*']
    sources:
      - type: file
        path: retroarch.cfg
      
    # create desktop entry